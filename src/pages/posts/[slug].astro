---
/**
 * Astro åŠ¨æ€è·¯ç”±ç¤ºä¾‹ï¼šæ–‡ç« è¯¦æƒ…é¡µ
 * è·¯å¾„ï¼šsrc/pages/posts/[slug].astro
 */
import Layout from "../../layouts/Layout.astro";
import { getPostBySlug } from "../../lib/notion";
import { getPostPaths, getTableOfContents, getReadingTime } from "../../lib/notion-helpers";
import { getPageRecordMap, isPageAccessible } from "../../lib/notion-recordmap";
import { buildPageIdToSlugMap } from "../../lib/notion-page-map";
import NotionRenderer from "../../components/NotionRenderer";

// Astro é™æ€è·¯å¾„ç”Ÿæˆ - åªæ„å»ºå¯è®¿é—®çš„é¡µé¢
export async function getStaticPaths() {
	// é¢„åŠ è½½ pageId->slug æ˜ å°„
	await buildPageIdToSlugMap();

	const allPaths = await getPostPaths();

	// è¿‡æ»¤å‡ºå¯è®¿é—®çš„é¡µé¢
	const accessiblePaths = [];

	for (const path of allPaths) {
		const isAccessible = await isPageAccessible(path.props.post.id);

		if (isAccessible) {
			accessiblePaths.push(path);
		} else {
			console.warn(`âš ï¸  è·³è¿‡ä¸å¯è®¿é—®çš„é¡µé¢: ${path.params.slug} (${path.props.post.title})`);
			console.warn(`   æç¤º: åœ¨ Notion ä¸­ä½¿ç”¨ "Share to web" å…¬å¼€æ­¤é¡µé¢åé‡æ–°æ„å»º`);
		}
	}

	console.log(
		`âœ“ æ‰¾åˆ° ${accessiblePaths.length} ä¸ªå¯è®¿é—®çš„é¡µé¢ï¼ˆè·³è¿‡ ${allPaths.length - accessiblePaths.length} ä¸ªæœªå…¬å¼€é¡µé¢ï¼‰`,
	);

	return accessiblePaths;
}

const { slug } = Astro.params;
const { post } = Astro.props;

// æ£€æŸ¥æ˜¯å¦æ˜¯é¢„è§ˆæ¨¡å¼ï¼ˆé€šè¿‡æŸ¥è¯¢å‚æ•°ï¼‰
const isPreviewMode = Astro.url.searchParams.has('preview');

// éªŒè¯æ–‡ç« çŠ¶æ€ï¼ˆé¢„è§ˆæ¨¡å¼ä¸‹å…è®¸è‰ç¨¿ï¼‰
if (!post || (!isPreviewMode && post.status !== 'Published')) {
  return new Response(null, {
    status: 404,
    statusText: 'Not Found'
  });
}

const isDraft = post.status !== 'Published';

// è·å–æ–‡ç« å†…å®¹
const recordMap = await getPageRecordMap(post.id);
const toc = await getTableOfContents(post.id);
const readingTime = await getReadingTime(post.id);

// SEO å…ƒæ•°æ®
const pageTitle = post.seoTitle || post.title;
const pageDescription = post.description || `é˜…è¯»æ–‡ç« ï¼š${post.title}`;
---

<Layout title={`${pageTitle} - A Demain`} description={pageDescription}>
  <article class="post-detail">
    <!-- è‰ç¨¿é¢„è§ˆæç¤º -->
    {isDraft && (
      <div class="draft-banner">
        âš ï¸ è¿™æ˜¯è‰ç¨¿é¢„è§ˆ - æœªå…¬å¼€å‘å¸ƒ
      </div>
    )}

    <!-- æ–‡ç« å¤´éƒ¨ -->
    <header class="post-header">
      {post.coverImage && (
        <img src={post.coverImage} alt={post.title} class="post-hero-image" />
      )}
      
      <div class="post-header-content">
        <div class="post-meta">
          {post.category && (
            <span class="category">{post.category}</span>
          )}
          {post.featured && (
            <span class="featured">â­ ç²¾é€‰æ–‡ç« </span>
          )}
        </div>
        
        <h1 class="post-title">{post.title}</h1>
        
        {post.description && (
          <p class="post-description">{post.description}</p>
        )}
        
        <div class="post-info">
          {post.publishedDate && (
            <time datetime={post.publishedDate}>
              å‘å¸ƒäº {new Date(post.publishedDate).toLocaleDateString('zh-CN')}
            </time>
          )}
          
          {post.updatedDate && post.updatedDate !== post.publishedDate && (
            <span class="updated">
              æ›´æ–°äº {new Date(post.updatedDate).toLocaleDateString('zh-CN')}
            </span>
          )}
          
          <span class="reading-time">ğŸ“– çº¦ {readingTime} åˆ†é’Ÿé˜…è¯»</span>
        </div>
        
        {post.tags.length > 0 && (
          <div class="post-tags">
            {post.tags.map(tag => (
              <a href={`/tags/${tag}`} class="tag">#{tag}</a>
            ))}
          </div>
        )}
      </div>
    </header>

    <!-- æ–‡ç« å†…å®¹åŒºåŸŸ -->
    <div class="post-content-wrapper">
      <!-- ç›®å½• -->
      {toc.length > 0 && (
        <aside class="toc-sidebar">
          <nav class="toc">
            <h3>ç›®å½•</h3>
            <ul>
              {toc.map(item => (
                <li class={`toc-item toc-level-${item.level}`}>
                  <a href={`#${item.id}`}>{item.text}</a>
                </li>
              ))}
            </ul>
          </nav>
        </aside>
      )}

      <!-- æ–‡ç« ä¸»ä½“å†…å®¹ -->
      <main class="post-content">
        <NotionRenderer
          client:load
          recordMap={recordMap}
          rootPageId={post.id}
          slug={slug}
          post={post}
        />
      </main>
    </div>

    <!-- æ–‡ç« åº•éƒ¨ -->
    <footer class="post-footer">
      <div class="post-actions">
        <a href="/posts" class="btn-back">â† è¿”å›æ–‡ç« åˆ—è¡¨</a>
      </div>
      
      <div class="post-share">
        <span>åˆ†äº«åˆ°ï¼š</span>
        <a href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.title)}&url=${Astro.url}`} 
           target="_blank" 
           rel="noopener noreferrer"
           class="share-btn twitter">
          Twitter
        </a>
      </div>
    </footer>
  </article>
</Layout>

<style>
  .post-detail {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  /* è‰ç¨¿é¢„è§ˆæç¤º */
  .draft-banner {
    background: #ff9800;
    color: white;
    padding: 1rem;
    text-align: center;
    font-weight: bold;
    border-radius: 8px;
    margin-bottom: 2rem;
  }

  /* æ–‡ç« å¤´éƒ¨ */
  .post-header {
    margin-bottom: 3rem;
  }

  .post-hero-image {
    width: 100%;
    max-height: 400px;
    object-fit: cover;
    border-radius: 12px;
    margin-bottom: 2rem;
  }

  .post-header-content {
    max-width: 800px;
    margin: 0 auto;
  }

  .post-meta {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .category,
  .featured {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    background: var(--color-primary);
    color: white;
  }

  .post-title {
    font-size: 2.5rem;
    line-height: 1.2;
    margin-bottom: 1rem;
  }

  .post-description {
    font-size: 1.25rem;
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin-bottom: 1.5rem;
  }

  .post-info {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    color: var(--color-text-secondary);
    font-size: 0.875rem;
    margin-bottom: 1rem;
  }

  .post-info time,
  .post-info .updated,
  .post-info .reading-time {
    display: flex;
    align-items: center;
  }

  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tag {
    padding: 0.25rem 0.75rem;
    background: var(--color-bg-secondary);
    border-radius: 12px;
    text-decoration: none;
    font-size: 0.875rem;
    transition: background 0.2s;
  }

  .tag:hover {
    background: var(--color-primary);
    color: white;
  }

  /* å†…å®¹å¸ƒå±€ */
  .post-content-wrapper {
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
  }

  /* ç›®å½•ä¾§è¾¹æ  */
  .toc-sidebar {
    position: sticky;
    top: 2rem;
    align-self: start;
  }

  .toc {
    padding: 1rem;
    background: var(--color-bg-secondary);
    border-radius: 8px;
  }

  .toc h3 {
    margin: 0 0 1rem 0;
    font-size: 1rem;
  }

  .toc ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-item {
    margin-bottom: 0.5rem;
  }

  .toc-item a {
    text-decoration: none;
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    transition: color 0.2s;
  }

  .toc-item a:hover {
    color: var(--color-primary);
  }

  .toc-level-1 { padding-left: 0; }
  .toc-level-2 { padding-left: 1rem; }
  .toc-level-3 { padding-left: 2rem; }

  /* æ–‡ç« å†…å®¹ */
  .post-content {
    max-width: 800px;
  }

  /* react-notion-x æ ·å¼è¦†ç›– */
  .post-content :global(.notion) {
    font-size: 1.05rem;
  }

  /* æ–‡ç« åº•éƒ¨ */
  .post-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 4rem;
    padding-top: 2rem;
    border-top: 1px solid var(--color-border);
  }

  .btn-back {
    padding: 0.75rem 1.5rem;
    background: var(--color-bg-secondary);
    border-radius: 8px;
    text-decoration: none;
    transition: transform 0.2s;
  }

  .btn-back:hover {
    transform: translateX(-4px);
  }

  .post-share {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .share-btn {
    padding: 0.5rem 1rem;
    background: var(--color-primary);
    color: white;
    border-radius: 8px;
    text-decoration: none;
    transition: opacity 0.2s;
  }

  .share-btn:hover {
    opacity: 0.8;
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .post-content-wrapper {
      grid-template-columns: 1fr;
    }

    .toc-sidebar {
      position: static;
    }

    .post-title {
      font-size: 1.75rem;
    }

    .post-footer {
      flex-direction: column;
      gap: 1rem;
    }
  }
</style>
